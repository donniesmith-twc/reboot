<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<style type="text/css">body{margin:0px;padding:0px;}</style>
</head>
<body>
<div id="csAdDiv"></div>
<div id="csTracking" style="display:none;"><!-- Line Item %eaid! ==  Creative ID %ecid! --></div>
<script type="text/javascript">

var testenv=false; // should always be false 
if (!window.location.origin)
     window.location.origin = window.location.protocol+"//"+window.location.host;
if(/(wideout|localhost)/i.test(window.location.origin)) testenv=true;
var swfFile="300x250.swf"; //main swf file
var imgFile="backup.jpg"; //backup image
var imgAlt="LL Bean"; //campaign name
var adDir="http://s.imwx.com/v.1.1/ads/creatives/llbean/1014/"; //creative preview path of swf http://s.imwx.com/v.1.0/ads/creatives/llbean/1014/
var imwxPath="http://s.imwx.com/v.1.0/ads/creatives/llbean/1014/"; //external file path
var clickTag="http://ad.doubleclick.net/ddm/trackclk/N9329.286110.THEWEATHERCHANNEL/B8253473.112217145;dc_trk_aid=285316088;dc_trk_cid=59831451"; // clickthru
var clickDefault="http://ad.doubleclick.net/ddm/trackclk/N9329.286110.THEWEATHERCHANNEL/B8253473.112217145;dc_trk_aid=285316088;dc_trk_cid=59831451"; //backup image clickthru
var impPixel="http://ad.doubleclick.net/ddm/trackimp/N9329.286110.THEWEATHERCHANNEL/B8253473.112217145;dc_trk_aid=285316088;dc_trk_cid=59831451;ord=%%CACHEBUSTER%%?"; // pixel impression // pixel tracker
var surveyURL=""; //survey url



    function csSetVars(){
	 // setting all variables for flash
    	csAd.vars.Path = imwxPath;
    // Reboot Edit - start
        if (csAd.reboot) { // map to reboot data
             csAd.vars.temp = csAd.data.body[1].doc.MOData.tmpF;
             csAd.vars.wxValue = csInitCond(csAd.data.body[1].doc.MOData.sky);
             csAd.vars.wxNum = csAd.data.body[1].doc.MOData.sky;
             csAd.vars.wxCity = csAd.data.body[0].doc.cityNm;
             csAd.vars.clickTag = encodeURIComponent(csAd.tracking.clickTag);
        }else if(csAd.testing){
            csAd.vars.temp = parent.testProps.temp;
            csAd.vars.wxValue = csInitCond(parent.testProps.wxIcon);
    		csAd.vars.wxNum = parent.testProps.wxIcon;
    		csAd.vars.wxCity = csAd.data[0].Location.city.toUpperCase();
    		csAd.vars.clickTag = encodeURIComponent(csAd.tracking.clickTag);
    	
        }else{
            csAd.vars.temp = csAd.data[0].HiradObservation.temp;
            csAd.vars.wxValue = csInitCond(csAd.data[0].HiradObservation.wxIcon);
    		csAd.vars.wxNum = csAd.data[0].HiradObservation.wxIcon;
    		csAd.vars.wxCity = csAd.data[0].Location.city.toUpperCase();
            csAd.vars.clickTag = encodeURIComponent(csAd.tracking.dfpClick+csAd.tracking.clickTag);
        }
       
	csWriteFlash();
	csWritePixel();
	csWriteSurvey();
    }

    function csInitCond(wxIcon){
        var adCond;
        switch(String(wxIcon)){
            case "0":  adCond = {i:"0",  b:"Stormy", d:"Tornado", t:"na"};break;
            case "1":  adCond = {i:"1",  b:"Stormy", d:"Tropical Storm", t:"na"};break;
            case "2":  adCond = {i:"2",  b:"Stormy", d:"Hurricane", t:"na"};break;
            case "3":  adCond = {i:"3",  b:"Stormy", d:"Strong Thunderstorms", t:"na"};break;
            case "4":  adCond = {i:"4",  b:"Stormy", d:"Thunderstorms", t:"na"};break;
            case "5":  adCond = {i:"5",  b:"Wintry", d:"Rain and Snow", t:"na"};break;
            case "6":  adCond = {i:"6",  b:"Wintry", d:"Rain and Sleet", t:"na"};break;
            case "7":  adCond = {i:"7",  b:"Wintry", d:"Wintry Mix", t:"na"};break;
            case "8":  adCond = {i:"8",  b:"Wintry", d:"Freezing Drizzle", t:"na"};break;
            case "9":  adCond = {i:"9",  b:"Rainy", d:"Drizzle", t:"na"};break;
            case "10": adCond = {i:"10", b:"Rainy", d:"Freezing Rain", t:"na"};break;
            case "11": adCond = {i:"11", b:"Rainy", d:"Showers", t:"na"};break;
            case "12": adCond = {i:"12", b:"Rainy", d:"Rain", t:"na"};break;
            case "13": adCond = {i:"13", b:"Wintry", d:"Flurries", t:"na"};break;
            case "14": adCond = {i:"14", b:"Wintry", d:"Snow Showers", t:"na"};break;
            case "15": adCond = {i:"15", b:"Wintry", d:"Blowing Snow", t:"na"};break;
            case "16": adCond = {i:"16", b:"Wintry", d:"Snow", t:"na"};break;
            case "17": adCond = {i:"17", b:"Wintry", d:"Hail", t:"na"};break;
            case "18": adCond = {i:"18", b:"Wintry", d:"Sleet", t:"na"};break;
            case "19": adCond = {i:"19", b:"Low Visibility", d:"Dust", t:"na"};break;
            case "20": adCond = {i:"20", b:"Low Visibility", d:"Fog", t:"na"};break;
            case "21": adCond = {i:"21", b:"Low Visibility", d:"Haze", t:"na"};break;
            case "22": adCond = {i:"22", b:"Low Visibility", d:"Smoke", t:"na"};break;
            case "23": adCond = {i:"23", b:"Windy", d:"Breezy", t:"na"};break;
            case "24": adCond = {i:"24", b:"Windy", d:"Windy", t:"na"};break;		  
            case "25": adCond = {i:"25", b:"Wintry", d:"Frigid", t:"na"};break;
            case "26": adCond = {i:"26", b:"Cloudy", d:"Cloudy", t:"na"};break;
            case "27": adCond = {i:"27", b:"Cloudy", d:"Mostly Cloudy", t:"night"};break;
            case "28": adCond = {i:"28", b:"Cloudy", d:"Mostly Cloudy", t:"day"};break;
            case "29": adCond = {i:"29", b:"Cloudy", d:"Partly Cloudy", t:"night"};break;
            case "30": adCond = {i:"30", b:"Cloudy", d:"Partly Cloudy", t:"day"};break;
            case "31": adCond = {i:"31", b:"Clear", d:"Clear", t:"night"};break;
            case "32": adCond = {i:"32", b:"Sunny", d:"Sunny", t:"day"};break;
            case "33": adCond = {i:"33", b:"Clear", d:"Mostly Clear", t:"night"};break;
            case "34": adCond = {i:"34", b:"Sunny", d:"Mostly Sunny", t:"day"};break;
            case "35": adCond = {i:"35", b:"Wintry", d:"Mixed Rain/Hail", t:"na"};break;
            case "36": adCond = {i:"36", b:"Sunny", d:"Hot", t:"day"};break;		  
            case "37": adCond = {i:"37", b:"Stormy", d:"Isolated Thunderstorms", t:"day"};break;
            case "38": adCond = {i:"38", b:"Stormy", d:"Scattered Thunderstorms", t:"day"};break;
            case "39": adCond = {i:"39", b:"Rainy", d:"Scattered Showers", t:"day"};break;
            case "40": adCond = {i:"40", b:"Rainy", d:"Heavy Rain", t:"na"};break;
            case "41": adCond = {i:"41", b:"Wintry", d:"Scattered Snow Showers", t:"na"};break;
            case "42": adCond = {i:"42", b:"Wintry", d:"Heavy Snow", t:"na"};break;
            case "43": adCond = {i:"43", b:"Wintry", d:"Blizzard", t:"na"};break;
            case "44": adCond = {i:"44", b:"Default", d:"Not Available", t:"na"};break;		  
            case "45": adCond = {i:"45", b:"Rainy", d:"Scattered Showers", t:"night"};break;
            case "46": adCond = {i:"46", b:"Wintry", d:"Scattered Snow Showers", t:"night"};break;
            case "47": adCond = {i:"47", b:"Stormy", d:"Scattered Thunderstorms", t:"night"};break;
            default:   adCond = {i:"na", b:"na", d:"Not Available", t:"na"};break;
        }
        return adCond.b;
    }
    
    /****** minimal editing required below this line ******/
   
    
    var csAd = {
        tracking:{
            clickTag:clickTag,
            dfpClick:"%%CLICK_URL_UNESC%%",
            pixel:impPixel,
            defaultClick:clickDefault
        },    
        
        width: 300,
        height:250,
        dir:adDir,
        f:{ // flash
            swf:swfFile,
            version: 10,
            wmode: "opaque"
        },
        d:{ // default
            img:imgFile,
            alt:imgAlt
        },
        ids:{ // various id strings for this ad
            creative:"%ecid!",
            lineItem:"%eaid!",
            loc:"%%PATTERN:loc%%",
            key:"e88c94dc-a740-102c-bafd-001321203584",
            data:"" // dataset added:
        },
        data:{},
        customData:{},
        dataCheck:0,
        dataLocs:["%%PATTERN:loc%%"], // comma separated list of locIDs for mobagg call
        errors:[],
        vars:{},
        timer:0,
        timerCount:0,
        testing:testenv
    };

    function csInit(){
	
        try{
            if(csAd.testing){
                csAd.ids.loc = parent.testProps.zip;
                csAd.dataLocs[0] = csAd.ids.loc;
            }else{
                csAd.ids.loc = csAd.ids.loc.split(':')[0];
                csAd.ids.loc = csAd.ids.loc.split('$')[0];
                csAd.dataLocs[0] = csAd.dataLocs[0].split(':')[0];
                csAd.dataLocs[0] = csAd.dataLocs[0].split('$')[0];
            }
            // Reboot Edit - start
            csAd.rebootCheck = function(){
                 try{
                      csAd.ids.locReboot = parent.TWC.pco.getNodeValue('ad','location','loc').loc;
                      csAd.reboot = true;
                 }catch(err){
                      csAd.errors.push("isReboot: "+ err.message);
                      csAd.reboot = false;
                 }
            }

            csAd.rebootCheck();

            if (csAd.reboot) {
                 // Replacing mobagg call with the just the necessary DSX calls for this adaptor, which include
                 // three records: (loc; MORecord; DFRecord)
                 csAddScript("http://dsx.weather.com/wxd/v2/(loc;MORecord;DFRecord)/en_US/(" + csAd.ids.locReboot + ")?api=7bb1c920-7027-4289-9c96-ae5e263980bc&jsonp=csDataSave");
                 if(!navigator.userAgent.match(/MSIE/i)){
                      csAd.dataCheck = setTimeout(csDataFail, 7000);
                 }
            }else{
                 csData();                  
            }
            // Reboot Edit - end 
        }catch(err){
            csWriteDefault("csInit: "+ err.name + " - "+ err.message);
        }
    }

    function toTitleCase(str){ // Reboot Edit - start
        return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
    }// Reboot Edit - end

    function csAddScript(scriptSrc){ 
        var myscript = document.createElement('script');
        myscript.setAttribute('type', 'text/javascript'); 
        myscript.setAttribute('src', scriptSrc); 
        document.body.appendChild(myscript);
    }

    function csData(){
        csAddScript("http://wxdata.weather.com/wxdata/mobile/mobagg/"+csAd.dataLocs.toString()+".js?key=" + csAd.ids.key + "&cb=csDataSave");
         if(!navigator.userAgent.match(/MSIE/i)){
	csAd.dataCheck = setTimeout(csDataFail, 7000);
	 }
    }

    function csDataFail(){
        clearTimeout(csAd.dataCheck);
        csAd.dataCheck = "failed";
        csWriteDefault("csDataFail: ds2 timeout");
    }

    // Reboot Edit - start
    function csDataSave(JSON){
         clearTimeout(csAd.dataCheck);
         csAd.data = JSON;
         if (csAd.reboot) {
              if (JSON.status == 200) {
                   csSetVars();
              }else{
                   csWriteDefault("csDataSaveReboot: status = "+ JSON.status);
              }
         }else{
              if (csAd.data.length == csAd.dataLocs.length) {
                   csSetVars();
              }else{
                   csWriteDefault("csDataSave: ds2 error")
              }     
         }
    }
    // Reboot Edit - end

    function csWriteDefault(reason){
        csAd.errors.push(reason);
        if (csAd.d.img != "") {
            var tDiv = document.getElementById("csAdDiv");
            var link = document.createElement("a");
	    if(csAd.testing){
	    link.href = csAd.tracking.defaultClick;
	    }else{
	    link.href = csAd.tracking.dfpClick + csAd.tracking.defaultClick;
	    }
            link.target = "_blank";
            var image = document.createElement("img");
            image.src = csAd.dir + csAd.d.img;
            image.height = csAd.height;
            image.width = csAd.width;
            image.alt = csAd.d.alt;
            image.border = 0;
            image.id = reason;
            link.appendChild(image);
            tDiv.appendChild(link);
        }
    }

    function csWriteFlash(){
        function getFlashVer(){var i,a,o,p,s="Shockwave",f="Flash",t=" 2.0",u=s+" "+f,v=s+f+".",rSW=RegExp("^"+u+" (\\d+)");if((o=navigator.plugins)&&(p=o[u]||o[u+t])&&(a=p.description.match(rSW)))return a[1];else if(!!(window.ActiveXObject))for(i=20;i>0;i--)try{if(!!(new ActiveXObject(v+v+i)))return i}catch(e){}return 0;
                              }
        try{
            if (getFlashVer() >= csAd.f.version) {
                csAd.flashVars = "";
                for (var i in csAd.vars) {
                    csAd.flashVars += i+"="+csAd.vars[i] + "&";
                }
                var swf = csAd.dir + csAd.f.swf;
                var outputSwfObj = '<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version='+csAd.f.version+',0,0,0" width="' +  csAd.width + '" height="' +  csAd.height + '" id="' +  csAd.ids.creative + '_swf" align="middle">'
                +'<param name="allownetworking" value="all" />'
                +'<param name="allowScriptAccess" value="always" />'
                +'<param name="allowFullScreen" value="false" />'
                +'<param name="wmode" value="'+csAd.f.wmode + '" />'
                +'<param name="flashVars" value="'+csAd.flashVars+'"/>'
                +'<param name="movie" value="'+swf+'" /><param name="quality" value="high" /><embed src="'+swf+'" quality="high" width="'+csAd.width+'" height="'+csAd.height+'" name="'+csAd.ids.creative+'SWF" align="middle" allowScriptAccess="always" allownetworking="all" wmode="'+csAd.f.wmode+'" allowFullScreen="false" type="application/x-shockwave-flash" flashVars="'+csAd.flashVars+'" />'
                +'</object>';
                // add swf object code to div
                var adDiv = document.createElement('div');
                adDiv.id = "csFlashDiv";
                adDiv.innerHTML = outputSwfObj;
                // Reboot Edit - start
                var csAdDiv = document.getElementById("csAdDiv");
                csAdDiv.appendChild(adDiv);
                // document.body.appendChild(adDiv);
                // Reboot Edit - end

            }else{
                csWriteDefault("csWriteFlash: wrongFlashVersion");
            }    
        }catch(err){
            csWriteDefault("csWriteFlash: "+ err.name + " - "+ err.message);  
        }
    }

    function csWritePixel(){
	if (impPixel!=""){
            var tDiv = document.getElementById("csTracking");
            tDiv.innerHTML="<img src="+csAd.tracking.pixel+" height='1' width='1' border='0' style='display:none'>";
	}
    }
    function csWriteSurvey(){
	if (surveyURL!=""){
	    var pixDiv=document.createElement("div");
	    pixDiv.innerHTML = '<img src="'+surveyURL+'" height="1" width="1" border="0" style="display:none;">';
	    document.body.appendChild(pixDiv);
	}
    }
    window.onload = function() {csInit();};
</script>
</body>
</html>
